DO $$
DECLARE
    yr INTEGER;
BEGIN
    FOR yr IN 1970..2021 LOOP
        WITH today AS (
            SELECT * FROM actor_films
            WHERE year = yr
        ), avg_rating AS (
            SELECT actorid, AVG(rating) AS avg_rating
            FROM today
            GROUP BY actorid
        )
	INSERT INTO actors
	SELECT t.actor as actor,
		t.actorid as actorid,
		t.year as currentyear,
		t.filmid  as filmid,
		ARRAY[ROW(t.film, t.votes, t.rating)::films] AS films,
		CASE WHEN t.year = 2025 THEN TRUE ELSE FALSE
		END AS isactive,
	
		CASE WHEN ar.avg_rating >8 THEN 'star'
					WHEN ar.avg_rating > 7 AND ar.avg_rating <= 8 THEN 'good'
					WHEN ar.avg_rating > 6 AND ar.avg_rating <= 7 THEN 'average'
					ELSE 'bad'
				END::quality_class

		FROM today t 
		LEFT JOIN avg_rating  ar
		ON t.actorid = ar.actorid;
	END LOOP;
END $$;
