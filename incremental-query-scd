--append 2021 data to 2016 data
WITH lastyear_val AS (
	SELECT 2016 AS lastyear,2021 AS newyear
),
--got new the record
past AS (
	SELECT * 
	FROM actors_history_scd, lastyear_val
	WHERE start_year = lastyear_val.lastyear
--unnest present data 
),unnestedrating as (
	SELECT
	actor,actorid, currentyear,
    (UNNEST(films)).rating::real AS filmrating
	FROM actors,lastyear_val
	WHERE currentyear = lastyear_val.newyear
	),
presentaggdata AS (
	SELECT actor, actorid, currentyear,AVG(filmrating) as avg_rating
	FROM unnestedrating
	GROUP BY actor,actorid, currentyear
),present AS (
	SELECT actor,actorid, currentyear,
	CASE 
				  WHEN ar.avg_rating > 8 THEN 'star'
				  WHEN ar.avg_rating > 7 THEN 'good'
				  WHEN ar.avg_rating > 6 THEN 'average'
				  ELSE 'bad'
	END AS quality_class 
	FROM presentaggdata ar
),newdata AS (
	SELECT 
		p.actorid, 
		p.actor, 
		CASE 
			WHEN pa.end_quality_class::TEXT = p.quality_class::TEXT THEN pa.start_year 
			ELSE pa.newyear 
		END AS start_year,
		CASE 
			WHEN pa.end_quality_class::TEXT = p.quality_class::TEXT THEN  lastyear_val.newyear
			ELSE lastyear_val.newyear 
		END AS end_year,
		pa.currentyear AS currentyear, 
		CASE 
			WHEN pa.end_quality_class::TEXT = p.quality_class::TEXT THEN pa.start_quality_class::TEXT 
			ELSE p.quality_class 
		END AS start_quality_class,
		p.quality_class AS end_quality_class,
		CASE WHEN p.currentyear = lastyear_val.newyear THEN TRUE ELSE FALSE END AS start_isactive,
		NULL AS end_isactive
	FROM present p
	FULL OUTER JOIN past pa ON pa.actorid = p.actorid,lastyear_val 
)
SELECT * FROM newdata
order by 2
